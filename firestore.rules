rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().isSuperAdmin == true;
    }
    
    function hasInstitutionAccess(institutionId) {
      return isAuthenticated() && (
        isSuperAdmin() ||
        (institutionId in getUserData().roles 
          && getUserData().roles[institutionId].isActive == true)
      );
    }
    
    function getUserRole(institutionId) {
      return getUserData().roles[institutionId].role;
    }
    
    function canMarkAttendance(institutionId) {
      return isSuperAdmin() || (
        hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) in ['admin', 'supervisor', 'class_rep']
      );
    }
    
    function canManageInstitution(institutionId) {
      return isSuperAdmin() || (
        hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) == 'admin'
      );
    }
    
    function isInstitutionAdmin(institutionId) {
      return isAuthenticated() && (
        isSuperAdmin() || (
          institutionId in getUserData().roles 
          && getUserData().roles[institutionId].role == 'admin'
          && getUserData().roles[institutionId].isActive == true
        )
      );
    }
    
    function canManageUser(targetUserId) {
      return isAuthenticated() && (
        isSuperAdmin() || (
          // Institution admin can manage users with roles in their institution
          targetUserId in resource.data.roles 
          && resource.data.roles[targetUserId].isActive == true
          && isInstitutionAdmin(targetUserId)
        )
      );
    }
    
    function canReadUser(targetUserId) {
      return isAuthenticated() && (
        isSuperAdmin() || 
        request.auth.uid == targetUserId ||
        // Institution admin can read users with roles in their institution
        (targetUserId in resource.data.roles 
          && resource.data.roles[targetUserId].isActive == true
          && getUserData().roles.keys().hasAny([resource.data.roles.keys()]))
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Read: own profile, super admin, or institution admin for users in their institution
      allow read: if isAuthenticated() && (
        request.auth.uid == get(/databases/$(database)/documents/users/$(userId)).data.uid ||
        isSuperAdmin() ||
        // Institution admins can read users with roles in their institutions
        (
          let userData = get(/databases/$(database)/documents/users/$(userId)).data;
          userData.roles.keys().hasAny(getUserData().roles.keys()) &&
          userData.roles[getUserData().roles.keys()[0]].isActive == true
        )
      );
      
      // Create: super admin only
      allow create: if isAuthenticated() && isSuperAdmin();
      
      // Update: own profile (limited), super admin (full), or institution admin (limited)
      allow update: if isAuthenticated() && (
        // Own profile - can update name but not isSuperAdmin or roles
        (request.auth.uid == get(/databases/$(database)/documents/users/$(userId)).data.uid &&
          request.resource.data.roles == resource.data.roles &&
          request.resource.data.isSuperAdmin == resource.data.isSuperAdmin) ||
        // Super admin - full access
        (isSuperAdmin()) ||
        // Institution admin - can update roles for their institution only
        (
          // Check if user has roles in admin's institutions
          let userRoles = resource.data.roles;
          let adminRoles = getUserData().roles;
          // Can only update if target user has role in admin's institution
          userRoles.keys().hasAny(adminRoles.keys()) &&
          // Cannot change isSuperAdmin
          request.resource.data.isSuperAdmin == resource.data.isSuperAdmin &&
          // Cannot change super admin status
          !(resource.data.isSuperAdmin == true)
        )
      );
      
      // Delete: super admin only (for now - can be enhanced with Cloud Functions)
      allow delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // Institutions
    match /institutions/{institutionId} {
      allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
      allow write: if canManageInstitution(institutionId);
      
      // Classes
      match /classes/{classId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if isSuperAdmin() || (
          hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor']
        );
      }
      
      // Students
      match /students/{studentId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if isSuperAdmin() || (
          hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor']
        );
      }
      
      // Attendance parent documents
      match /attendance/{attendanceId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if canMarkAttendance(institutionId);
        
        // Individual attendance records subcollection
        match /records/{studentId} {
          allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
          allow write: if canMarkAttendance(institutionId);
        }
      }
    }
  }
}

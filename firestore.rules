rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.token.email)).data;
    }
    
    function getUserDataById(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().isSuperAdmin == true;
    }
    
    function hasInstitutionAccess(institutionId) {
      return isAuthenticated() && (
        isSuperAdmin() ||
        (institutionId in getUserData().roles 
          && getUserData().roles[institutionId].isActive == true)
      );
    }
    
    function getUserRole(institutionId) {
      return getUserData().roles[institutionId].role;
    }
    
    function canMarkAttendance(institutionId) {
      return isSuperAdmin() || (
        hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) in ['admin', 'supervisor', 'class_rep']
      );
    }
    
    function canManageInstitution(institutionId) {
      return isSuperAdmin() || (
        hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) == 'admin'
      );
    }
    
    function isInstitutionAdmin(institutionId) {
      return isAuthenticated() && (
        isSuperAdmin() || (
          institutionId in getUserData().roles 
          && getUserData().roles[institutionId].role == 'admin'
          && getUserData().roles[institutionId].isActive == true
        )
      );
    }
    
    function hasSharedInstitutionAccess(targetUserId) {
      let targetUserData = getUserDataById(targetUserId);
      return targetUserData.roles.keys().hasAny(getUserData().roles.keys()) &&
             targetUserData.roles[getUserData().roles.keys()[0]].isActive == true;
    }
    
    function canUpdateInstitutionAdmin(targetUserId) {
      let targetUserRoles = getUserDataById(targetUserId).roles;
      let adminRoles = getUserData().roles;
      return targetUserRoles.keys().hasAny(adminRoles.keys()) &&
             !targetUserRoles['isSuperAdmin'];
    }
    
    // Users collection
    match /users/{userId} {
      // Read: own profile, super admin, or institution admin for users in their institution
      allow read: if isAuthenticated() && (
        request.auth.token.email == userId ||
        isSuperAdmin() ||
        hasSharedInstitutionAccess(userId)
      );
      
      // Create: super admin only
      allow create: if isAuthenticated() && isSuperAdmin();
      
      // Update: own profile (limited), super admin (full), or institution admin (limited)
      allow update: if isAuthenticated() && (
        // Own profile - can update name but not isSuperAdmin or roles
        (request.auth.token.email == userId &&
          request.resource.data.roles == resource.data.roles &&
          request.resource.data.isSuperAdmin == resource.data.isSuperAdmin) ||
        // Super admin - full access
        (isSuperAdmin()) ||
        // Institution admin - can update roles for their institution only
        (canUpdateInstitutionAdmin(userId) &&
          request.resource.data.isSuperAdmin == resource.data.isSuperAdmin &&
          !resource.data.isSuperAdmin)
      );
      
      // Delete: super admin only (for now - can be enhanced with Cloud Functions)
      allow delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // Institutions
    match /institutions/{institutionId} {
      allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
      allow write: if canManageInstitution(institutionId);
      
      // Classes
      match /classes/{classId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if isSuperAdmin() || (
          hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor']
        );
      }
      
      // Students
      match /students/{studentId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if isSuperAdmin() || (
          hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor']
        );
      }
      
      // Attendance parent documents
      match /attendance/{attendanceId} {
        allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
        allow write: if canMarkAttendance(institutionId);
        
        // Individual attendance records subcollection
        match /records/{studentId} {
          allow read: if isSuperAdmin() || hasInstitutionAccess(institutionId);
          allow write: if canMarkAttendance(institutionId);
        }
      }
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasInstitutionAccess(institutionId) {
      return isAuthenticated() 
        && institutionId in getUserData().roles 
        && getUserData().roles[institutionId].isActive == true;
    }
    
    function getUserRole(institutionId) {
      return getUserData().roles[institutionId].role;
    }
    
    function canMarkAttendance(institutionId) {
      return hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) in ['admin', 'supervisor', 'class_rep'];
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.roles == resource.data.roles;
    }
    
    // Institutions
    match /institutions/{institutionId} {
      allow read: if hasInstitutionAccess(institutionId);
      allow write: if hasInstitutionAccess(institutionId) 
        && getUserRole(institutionId) == 'admin';
      
      // Classes
      match /classes/{classId} {
        allow read: if hasInstitutionAccess(institutionId);
        allow write: if hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor'];
      }
      
      // Students
      match /students/{studentId} {
        allow read: if hasInstitutionAccess(institutionId);
        allow write: if hasInstitutionAccess(institutionId) 
          && getUserRole(institutionId) in ['admin', 'supervisor'];
      }
      
      // Attendance parent documents
      match /attendance/{attendanceId} {
        allow read: if hasInstitutionAccess(institutionId);
        allow write: if canMarkAttendance(institutionId);
        
        // Individual attendance records subcollection
        match /records/{studentId} {
          allow read: if hasInstitutionAccess(institutionId);
          allow write: if canMarkAttendance(institutionId);
        }
      }
    }
  }
}
